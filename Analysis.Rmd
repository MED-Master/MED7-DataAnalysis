---
title: "MED7_Analysis"
output: 
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
library(ggplot2)
library(tidyverse)
library(tidymodels)
library(skimr)
library(stringr)
library(corrplot)
library(RColorBrewer)
library("PerformanceAnalytics")
library("Hmisc")
library(Rmisc)
library(lubridate)
library(ggbeeswarm)
library(GGally)
library(effsize)
library(magrittr)
library(dplyr)
library(reticulate)

flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

```{r test, echo=FALSE,message=F, warning=F,results='hide'}



```

```{r logData, echo=FALSE,message=F, warning=F,results='hide'}

df_questionnaire <- read.table("Questionnaire_data.csv", header=TRUE, fill = FALSE, sep=",")

df_physiological <- list.files(path = "./MED7 Eval data Physiological", full.names = T) %>%
map_dfr(read_csv, .id = "file_path") %>%
group_by(file_path) %>%
dplyr::mutate(ParticipantID = group_indices())

df_sample <- list.files(recursive = TRUE, path = "./MED7 testLogs", pattern = "Sample.csv",full.names = T) %>%
map_dfr(read_csv, .id = "file_path") %>%
group_by(file_path) %>%
dplyr::mutate(ParticipantID = group_indices())

df_event <- list.files(recursive = TRUE, path = "./MED7 testLogs", pattern = "Event.csv",full.names = T) %>%
map_dfr(read_csv, .id = "file_path") %>%
group_by(file_path) %>%
dplyr::mutate(ParticipantID = group_indices())

questionnaire_Summary <- df_questionnaire %>% dplyr::group_by(Participant) %>% select(-Notes ) %>% na.omit()

physiological_Summary <- df_physiological %>% dplyr::group_by(file_path) %>% select(file_path, EDA, IBI, -ParticipantID) 

sample_Summary <- df_sample %>% dplyr::group_by(file_path) %>% select(-Framecount, -SessionID, -Email)

event_Summary <- df_event %>% dplyr::group_by(ParticipantID) %>% select(-Framecount, -SessionID, -Email, -ParticipantId, -TestId, -PlayedPattern)
#dfSummary <-  dfSummary %>% merge(dsSummary, by = "Participant", all = T)


```

```{r Pre-processing of Performance, echo=FALSE,message=F, warning=F,results='hide'}
#Performance table for overview
Performance <- table(event_Summary$Event,  event_Summary$file_path)
Performance = t(Performance)
Performance <- as.data.frame.matrix(Performance)

#Added performance from the Event column to event_Summary
#https://www.marsja.se/r-add-column-to-dataframe-based-on-other-columns-conditions-dplyr/

#spawns
event_Summary <- event_Summary %>% mutate(SpawnedMole =  case_when(Event == 'Mole Spawned' ~ "1"))
event_Summary <- event_Summary %>% mutate(SpawnedFakeMole =  case_when(Event == 'Fake Mole Spawned' ~ "1"))
#Shots
event_Summary <- event_Summary %>% mutate(Shots =  case_when(Event == 'Pointer Shoot' ~ "1"))
#Hit and misses
event_Summary <- event_Summary %>% mutate(Misses =  case_when(Event == 'Mole Missed' ~ "1"))
event_Summary <- event_Summary %>% mutate(Hits =  case_when(Event == 'Mole Hit' ~ "1"))
event_Summary <- event_Summary %>% mutate(RedHit =  case_when(Event == 'Fake Mole Hit' ~ "1"))
#Expired mole
event_Summary <- event_Summary %>% mutate(Mole_Expired =  case_when(Event == 'Mole Expired' ~ "1"))
event_Summary <- event_Summary %>% mutate(Fake_Mole_Expired =  case_when(Event == 'Fake Mole Expired' ~ "1"))


#Test dataframe
#test1 <- event_Summary %>% dplyr::group_by(file_path) %>% select(Event, SpawnedMole, SpawnedFakeMole, Shots, Misses, Hits, RedHit, Mole_Expired,  Fake_Mole_Expired)

#computing performance metrics per participant
#TODO : Amount of shots, Amount of Hits, Number of Spawned Moles, Moles pr. Sec, missed Shots, Moles Missed


```


```{r Overview}
physiological_Summary  %>%
  select(-file_path) %>%
   skim()

#sample_Summary[sample_Summary == "NULL"] <- NA
sample_Summary %>%
  select(-file_path) %>%
   skim()

```


```{python}
import matplotlib.pyplot as plt
from scipy import stats as sc
import pandas as pd

#py_dfSummary = r.dfSummary
#x = py_dfSummary["EDA"]
#y = py_dfSummary["IBI"]
#plt.scatter(x, y)
#plt.show()

py_dsSummary = r.dsSummary
x2 = py_dsSummary["RightControllerPosWorldX"]
y2 = py_dsSummary["RightControllerPosWorldY"]
users = py_dsSummary["Participant"]
plt.scatter(x2, y2)
plt.show()

slope, intercept, p, r2, std_err = sc.linregress(x2, y2)

def lr(x2):
  return slope * x2 + intercept

mymodel = list(map(lr, x2))

p_df = pd.DataFrame(x2, y2, users)
fig, ax = plt.subplots()
bp = p_df.groupby("users").plot(kind="kde", ax=ax)


plt.scatter(x2, y2)
plt.plot(x2, mymodel)
plt.show()

```

```{python}
import numpy as np
my_python_array = np.array([2,4,6,8])
for item in my_python_array:
    print(item)
    
exit
```

